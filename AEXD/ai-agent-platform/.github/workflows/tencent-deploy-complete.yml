name: ğŸš€ Tencent Cloud Auto Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'
  APP_NAME: 'ai-agent-platform'
  DEPLOY_PATH: '/var/www/ai-agent-platform'

jobs:
  build-and-deploy:
    name: ğŸŒ æ„å»ºå¹¶éƒ¨ç½²åˆ°è…¾è®¯äº‘
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“‚ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: âš™ï¸ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ğŸ”¨ æ„å»ºåº”ç”¨
      run: |
        npx prisma generate
        npm run build
        
    - name: ğŸ—‚ï¸ åˆ›å»ºéƒ¨ç½²åŒ…
      run: |
        # åˆ›å»ºéƒ¨ç½²åŒ…
        mkdir -p deployment
        cp -r .next deployment/
        cp -r public deployment/
        cp -r prisma deployment/
        cp -r app deployment/
        cp -r components deployment/
        cp package.json deployment/
        cp package-lock.json deployment/
        cp next.config.js deployment/
        cp ecosystem.config.js deployment/
        cp .env.production deployment/ || echo "åˆ›å»ºé»˜è®¤ç¯å¢ƒå˜é‡"
        
        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f deployment/.env.production ]; then
          echo 'DATABASE_URL="file:./data/production.db"' > deployment/.env.production
          echo 'ADMIN_PASSWORD="admin123456"' >> deployment/.env.production
          echo 'JWT_SECRET="$(openssl rand -base64 32)"' >> deployment/.env.production
          echo 'NODE_ENV="production"' >> deployment/.env.production
        fi
        
        # æ‰“åŒ…
        tar -czf deploy.tar.gz deployment/
        
    - name: ğŸ“¤ ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°è…¾è®¯äº‘
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.tencent_host }}
        username: ${{ secrets.tencent_username }}
        key: ${{ secrets.tencent_ssh_key }}
        port: ${{ secrets.tencent_port || 22 }}
        source: "deploy.tar.gz"
        target: "/tmp/"
        
    - name: ğŸš€ éƒ¨ç½²å¹¶å¯åŠ¨åº”ç”¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.tencent_host }}
        username: ${{ secrets.tencent_username }}
        key: ${{ secrets.tencent_ssh_key }}
        port: ${{ secrets.tencent_port || 22 }}
        script: |
          set -e
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘..."
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          cd ${{ env.DEPLOY_PATH }}
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"
          if [ -d ".next" ]; then
            echo "ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬åˆ°: $BACKUP_NAME"
            sudo tar -czf "$BACKUP_NAME.tar.gz" .next data/ 2>/dev/null || true
          fi
          
          # ä¸Šä¼ çš„éƒ¨ç½²åŒ…è§£å‹
          echo "ğŸ“‚ è§£å‹éƒ¨ç½²åŒ…..."
          sudo tar -xzf /tmp/deploy.tar.gz -C /tmp/
          
          # æ¸…ç†æ—§æ–‡ä»¶
          sudo rm -rf .next node_modules data/production.db-journal
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          sudo cp -r /tmp/deployment/* .
          
          # è®¾ç½®æƒé™
          sudo chown -R $USER:$USER ${{ env.DEPLOY_PATH }}
          
          # å®‰è£…ç”Ÿäº§ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
          npm ci --only=production --silent
          
          # æ•°æ®åº“åˆå§‹åŒ–
          echo "ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“..."
          npx prisma generate
          npx prisma db push --accept-data-loss
          
          # æ£€æŸ¥PM2æ˜¯å¦å®‰è£…
          if ! command -v pm2 >/dev/null 2>&1; then
            echo "ğŸ“¥ å®‰è£…PM2..."
            npm install -g pm2
          fi
          
          # é‡å¯åº”ç”¨
          echo "ğŸ”„ é‡å¯åº”ç”¨..."
          pm2 reload ${{ env.APP_NAME }} || pm2 start ecosystem.config.js
          
          # ä¿å­˜PM2é…ç½®
          pm2 save
          
          # æ£€æŸ¥åº”ç”¨çŠ¶æ€
          echo "ğŸ“Š æ£€æŸ¥åº”ç”¨çŠ¶æ€..."
          sleep 5
          pm2 status ${{ env.APP_NAME }}
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/deploy.tar.gz /tmp/deployment
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ åº”ç”¨åœ°å€: http://$(curl -s https://ipinfo.io/ip):3000"
          
    - name: ğŸ” å¥åº·æ£€æŸ¥
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.tencent_host }}
        username: ${{ secrets.tencent_username }}
        key: ${{ secrets.tencent_ssh_key }}
        port: ${{ secrets.tencent_port || 22 }}
        script: |
          echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
          sleep 10
          
          # æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
          if pm2 status | grep -q "${{ env.APP_NAME }}"; then
            echo "âœ… åº”ç”¨è¿è¡Œæ­£å¸¸"
          else
            echo "âŒ åº”ç”¨æœªè¿è¡Œ"
            exit 1
          fi
          
          # æ£€æŸ¥ç«¯å£
          if netstat -tlnp | grep -q ":3000"; then
            echo "âœ… ç«¯å£3000æ­£å¸¸ç›‘å¬"
          else
            echo "âŒ ç«¯å£3000æœªç›‘å¬"
            exit 1
          fi
          
    - name: ğŸ“¬ éƒ¨ç½²å®Œæˆé€šçŸ¥
      if: success()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.tencent_host }}
        username: ${{ secrets.tencent_username }}
        key: ${{ secrets.tencent_ssh_key }}
        port: ${{ secrets.tencent_port || 22 }}
        script: |
          echo "ğŸ‰ GitHub Actionsè‡ªåŠ¨éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“Š åº”ç”¨çŠ¶æ€:"
          pm2 list
          echo "ğŸŒ æœåŠ¡å™¨IP: $(curl -s https://ipinfo.io/ip)"