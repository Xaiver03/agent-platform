<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Ultimate 405 Error Fix Test</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        h1 { 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .test-section { 
            margin: 30px 0; 
            padding: 25px; 
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .test-section h2 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .result { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 10px; 
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .success { 
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-left: 5px solid #2E7D32;
        }
        .error { 
            background: linear-gradient(135deg, #f44336, #d32f2f);
            border-left: 5px solid #B71C1C;
        }
        .pending {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            border-left: 5px solid #E65100;
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            cursor: pointer;
            background: linear-gradient(135deg, #FF6B6B, #FF5252);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-pending { background: #FF9800; }
        .summary {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }
        .summary h3 {
            color: #FFD700;
            margin-bottom: 15px;
        }
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        .stat {
            text-align: center;
            padding: 10px;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Ultimate 405 Error Fix Test</h1>
        
        <div class="summary" id="summary">
            <h3>📊 Test Summary</h3>
            <div class="stats">
                <div class="stat">
                    <span class="stat-number" id="passed-count">0</span>
                    <span>✅ Passed</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="failed-count">0</span>
                    <span>❌ Failed</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="total-count">0</span>
                    <span>📋 Total</span>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>🎯 Critical Dynamic Route Tests</h2>
            <p>Testing the main routes that were causing 405 errors:</p>
            <div class="test-grid">
                <div>
                    <button onclick="testAgentGet()">Test Agent GET</button>
                    <button onclick="testAgentPut()">Test Agent PUT ⚡</button>
                    <button onclick="testAgentDelete()">Test Agent DELETE</button>
                </div>
                <div>
                    <button onclick="testSimpleDynamicGet()">Test Simple Dynamic GET</button>
                    <button onclick="testSimpleDynamicPut()">Test Simple Dynamic PUT ⚡</button>
                </div>
            </div>
            <div id="critical-results"></div>
        </div>

        <div class="test-section">
            <h2>✅ Control Tests (Should Work)</h2>
            <p>Testing static routes for comparison:</p>
            <div class="test-grid">
                <div>
                    <button onclick="testStaticPut()">Test Static PUT</button>
                    <button onclick="testAgentsGet()">Test Agents List GET</button>
                </div>
            </div>
            <div id="control-results"></div>
        </div>

        <div class="test-section">
            <h2>🔧 Full HTTP Methods Test</h2>
            <p>Complete test of all HTTP methods on the fixed route:</p>
            <div class="test-grid">
                <div>
                    <button onclick="testAllMethods()">🚀 Test All Methods</button>
                    <button onclick="testWithAuth()">🔐 Test With Auth</button>
                </div>
            </div>
            <div id="methods-results"></div>
        </div>

        <div class="test-section">
            <h2>🎭 Real-World Simulation - 真实更新流程</h2>
            <p>Simulate the actual agent update flow that was failing:</p>
            <div class="test-grid">
                <div>
                    <button onclick="simulateRealUpdate()">🎯 Simulate Real Agent Update</button>
                    <button onclick="clearResults()">🧹 Clear All Results</button>
                </div>
            </div>
            <div id="simulation-results"></div>
        </div>
    </div>

    <script>
        let testStats = { passed: 0, failed: 0, total: 0 };

        function updateStats() {
            document.getElementById('passed-count').textContent = testStats.passed;
            document.getElementById('failed-count').textContent = testStats.failed;
            document.getElementById('total-count').textContent = testStats.total;
        }

        function logResult(elementId, method, url, status, response, error = null) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const isSuccess = status >= 200 && status < 300;
            const resultClass = isSuccess ? 'success' : 'error';
            const statusIcon = isSuccess ? '✅' : '❌';
            const statusIndicator = isSuccess ? 'status-success' : 'status-error';
            
            // Update stats
            testStats.total++;
            if (isSuccess) testStats.passed++;
            else testStats.failed++;
            updateStats();
            
            const resultHtml = `
                <div class="result ${resultClass}">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="status-indicator ${statusIndicator}"></span>
                        <strong>${statusIcon} [${timestamp}] ${method} ${url}</strong>
                    </div>
                    <div><strong>Status:</strong> ${status}</div>
                    ${error ? `<div><strong>Error:</strong> ${error}</div>` : ''}
                    <div><strong>Response:</strong></div>
                    <pre style="white-space: pre-wrap; margin-top: 5px;">${JSON.stringify(response, null, 2)}</pre>
                </div>
            `;
            element.innerHTML += resultHtml;
        }

        // Critical Tests - The main issue
        async function testAgentGet() {
            try {
                const response = await fetch('/api/agents/test-agent-123', {
                    method: 'GET'
                });
                const data = await response.json();
                logResult('critical-results', 'GET', '/api/agents/test-agent-123', response.status, data);
            } catch (error) {
                logResult('critical-results', 'GET', '/api/agents/test-agent-123', 0, null, error.message);
            }
        }

        async function testAgentPut() {
            try {
                const testData = {
                    name: "测试更新",
                    description: "这是修复405错误后的测试",
                    enabled: true
                };
                
                const response = await fetch('/api/agents/test-agent-123', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });
                const data = await response.json();
                logResult('critical-results', 'PUT', '/api/agents/test-agent-123', response.status, data);
            } catch (error) {
                logResult('critical-results', 'PUT', '/api/agents/test-agent-123', 0, null, error.message);
            }
        }

        async function testAgentDelete() {
            try {
                const response = await fetch('/api/agents/test-agent-123', {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await response.json();
                logResult('critical-results', 'DELETE', '/api/agents/test-agent-123', response.status, data);
            } catch (error) {
                logResult('critical-results', 'DELETE', '/api/agents/test-agent-123', 0, null, error.message);
            }
        }

        async function testSimpleDynamicGet() {
            try {
                const response = await fetch('/api/test-simple-dynamic/fix-test-123', {
                    method: 'GET'
                });
                const data = await response.json();
                logResult('critical-results', 'GET', '/api/test-simple-dynamic/fix-test-123', response.status, data);
            } catch (error) {
                logResult('critical-results', 'GET', '/api/test-simple-dynamic/fix-test-123', 0, null, error.message);
            }
        }

        async function testSimpleDynamicPut() {
            try {
                const response = await fetch('/api/test-simple-dynamic/fix-test-123', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: 'simple dynamic route fix' })
                });
                const data = await response.json();
                logResult('critical-results', 'PUT', '/api/test-simple-dynamic/fix-test-123', response.status, data);
            } catch (error) {
                logResult('critical-results', 'PUT', '/api/test-simple-dynamic/fix-test-123', 0, null, error.message);
            }
        }

        // Control Tests
        async function testStaticPut() {
            try {
                const response = await fetch('/api/simple-test', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: 'static route control' })
                });
                const data = await response.json();
                logResult('control-results', 'PUT', '/api/simple-test', response.status, data);
            } catch (error) {
                logResult('control-results', 'PUT', '/api/simple-test', 0, null, error.message);
            }
        }

        async function testAgentsGet() {
            try {
                const response = await fetch('/api/agents?limit=5');
                const data = await response.json();
                logResult('control-results', 'GET', '/api/agents', response.status, data);
            } catch (error) {
                logResult('control-results', 'GET', '/api/agents', 0, null, error.message);
            }
        }

        // Full Methods Test
        async function testAllMethods() {
            const methods = ['GET', 'PUT', 'DELETE', 'OPTIONS'];
            const testId = 'comprehensive-test-' + Date.now();
            
            for (const method of methods) {
                try {
                    const options = {
                        method: method,
                        headers: { 'Content-Type': 'application/json' }
                    };
                    
                    if (method === 'PUT') {
                        options.body = JSON.stringify({ 
                            name: `Test ${method}`,
                            description: `Testing ${method} method`,
                            test: true 
                        });
                    }
                    
                    const response = await fetch(`/api/agents/${testId}`, options);
                    let data;
                    
                    if (method === 'OPTIONS') {
                        data = { headers: Object.fromEntries(response.headers.entries()) };
                    } else {
                        data = await response.json();
                    }
                    
                    logResult('methods-results', method, `/api/agents/${testId}`, response.status, data);
                } catch (error) {
                    logResult('methods-results', method, `/api/agents/${testId}`, 0, null, error.message);
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function testWithAuth() {
            // This simulates authenticated requests
            try {
                const response = await fetch(`/api/agents/auth-test-${Date.now()}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        name: "认证测试",
                        description: "测试带认证的PUT请求",
                        enabled: true
                    })
                });
                const data = await response.json();
                logResult('methods-results', 'PUT (Auth)', '/api/agents/[id]', response.status, data);
            } catch (error) {
                logResult('methods-results', 'PUT (Auth)', '/api/agents/[id]', 0, null, error.message);
            }
        }

        // Real-world simulation
        async function simulateRealUpdate() {
            const realAgentData = {
                name: "ChatGPT",
                description: "OpenAI开发的大型语言模型，具有强大的对话和文本生成能力。",
                tags: "AI对话,文本生成,问答,写作助手",
                manager: "OpenAI",
                guideUrl: "https://chat.openai.com",
                homepage: "https://openai.com/chatgpt",
                icon: "🤖",
                enabled: true,
                themeColor: "#10A37F",
                coverImage: "https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800",
                guideContent: "<h2>使用指南</h2><p>ChatGPT是一个强大的AI助手，可以帮助您...</p>"
            };

            try {
                logResult('simulation-results', 'INFO', 'Real Update Simulation', 200, 
                    { message: "开始模拟真实的Agent更新流程...", data: realAgentData });

                const response = await fetch('/api/agents/real-update-test-' + Date.now(), {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(realAgentData)
                });

                const data = await response.json();
                
                if (response.status === 200 || response.status === 201) {
                    logResult('simulation-results', '🎉 REAL UPDATE', 'SUCCESS', response.status, 
                        { message: "🎊 真实更新流程测试成功！405错误已彻底修复！", response: data });
                } else {
                    logResult('simulation-results', '❌ REAL UPDATE', 'FAILED', response.status, data);
                }
            } catch (error) {
                logResult('simulation-results', '💥 REAL UPDATE', 'ERROR', 0, null, error.message);
            }
        }

        function clearResults() {
            const resultElements = ['critical-results', 'control-results', 'methods-results', 'simulation-results'];
            resultElements.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            testStats = { passed: 0, failed: 0, total: 0 };
            updateStats();
        }

        // Auto-run basic test on page load
        window.onload = function() {
            setTimeout(() => {
                testStaticPut(); // Control test first
                setTimeout(() => testAgentGet(), 500); // Then critical test
            }, 1000);
        }
    </script>
</body>
</html>