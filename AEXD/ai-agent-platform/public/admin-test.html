<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç•Œé¢æŒ‰é’®åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #1890ff;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 1px solid #d9d9d9;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 14px;
        }
        .success { 
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #389e0d;
        }
        .error { 
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #cf1322;
        }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            cursor: pointer;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #40a9ff;
        }
        .danger {
            background: #ff4d4f;
        }
        .danger:hover {
            background: #ff7875;
        }
        .warning {
            background: #faad14;
        }
        .warning:hover {
            background: #ffc53d;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        .input-group input, .input-group textarea {
            width: 300px;
            padding: 5px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
        }
        .agent-id-input {
            width: 100% !important;
            margin-bottom: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ ç®¡ç†ç•Œé¢æŒ‰é’®åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="input-group">
            <label>Agent ID:</label>
            <input type="text" id="agentId" class="agent-id-input" placeholder="è¾“å…¥è¦æµ‹è¯•çš„Agent ID" value="cmdr0bwyt000u5a69ndzjw4zr">
            <small>é»˜è®¤ä½¿ç”¨ä½ ä¹‹å‰æµ‹è¯•çš„Agent ID</small>
        </div>

        <div class="test-section">
            <h2>ğŸ“ Agent CRUD æ“ä½œæµ‹è¯•</h2>
            <button onclick="testAgentGet()">è·å–Agentä¿¡æ¯</button>
            <button onclick="testAgentUpdate()">æ›´æ–°Agent</button>
            <button class="danger" onclick="testAgentDelete()">åˆ é™¤Agent</button>
            <button onclick="testAgentCreate()">åˆ›å»ºAgent</button>
            <div id="agent-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ‘ï¸ æ˜¾ç¤º/éšè—åˆ‡æ¢æµ‹è¯•</h2>
            <button class="warning" onclick="testToggleHide()">éšè—Agent</button>
            <button onclick="testToggleShow()">æ˜¾ç¤ºAgent</button>
            <div id="toggle-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”˜ åé¦ˆæŒ‰é’®ç®¡ç†æµ‹è¯•</h2>
            <button onclick="testGetButtons()">è·å–åé¦ˆæŒ‰é’®</button>
            <button onclick="testCreateButton()">åˆ›å»ºåé¦ˆæŒ‰é’®</button>
            <button onclick="testUpdateButton()">æ›´æ–°åé¦ˆæŒ‰é’®</button>
            <button class="danger" onclick="testDeleteButton()">åˆ é™¤åé¦ˆæŒ‰é’®</button>
            <div id="button-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š æ•°æ®è·å–æµ‹è¯•</h2>
            <button onclick="testGetAgents()">è·å–æ‰€æœ‰Agents</button>
            <button onclick="testGetApplications()">è·å–ç”³è¯·è®°å½•</button>
            <button onclick="testGetFeedback()">è·å–åé¦ˆè®°å½•</button>
            <div id="data-results"></div>
        </div>
    </div>

    <script>
        let testButtonId = null; // å­˜å‚¨æµ‹è¯•åˆ›å»ºçš„æŒ‰é’®ID

        function logResult(elementId, operation, status, response, error = null) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const isSuccess = status >= 200 && status < 300;
            const resultClass = isSuccess ? 'success' : 'error';
            
            const resultHtml = `
                <div class="result ${resultClass}">
                    <strong>[${timestamp}] ${operation}</strong><br>
                    Status: ${status}<br>
                    ${error ? `Error: ${error}<br>` : ''}
                    Response: <pre>${JSON.stringify(response, null, 2)}</pre>
                </div>
            `;
            element.innerHTML += resultHtml;
        }

        function getAgentId() {
            return document.getElementById('agentId').value || 'cmdr0bwyt000u5a69ndzjw4zr';
        }

        // Agent CRUD æµ‹è¯•
        async function testAgentGet() {
            try {
                const response = await fetch(`/api/agents/${getAgentId()}`);
                const data = await response.json();
                logResult('agent-results', 'GET Agent', response.status, data);
            } catch (error) {
                logResult('agent-results', 'GET Agent', 0, null, error.message);
            }
        }

        async function testAgentUpdate() {
            try {
                const testData = {
                    name: "æµ‹è¯•æ›´æ–° " + new Date().getTime(),
                    description: "è¿™æ˜¯ä¸€ä¸ªç®¡ç†ç•Œé¢æµ‹è¯•æ›´æ–°",
                    enabled: true
                };
                const response = await fetch(`/api/agents/${getAgentId()}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });
                const data = await response.json();
                logResult('agent-results', 'UPDATE Agent', response.status, data);
            } catch (error) {
                logResult('agent-results', 'UPDATE Agent', 0, null, error.message);
            }
        }

        async function testAgentDelete() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æµ‹è¯•Agentå—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                const response = await fetch(`/api/agents/${getAgentId()}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await response.json();
                logResult('agent-results', 'DELETE Agent', response.status, data);
            } catch (error) {
                logResult('agent-results', 'DELETE Agent', 0, null, error.message);
            }
        }

        async function testAgentCreate() {
            try {
                const testData = {
                    name: "æµ‹è¯•Agent " + new Date().getTime(),
                    description: "è¿™æ˜¯é€šè¿‡æµ‹è¯•é¡µé¢åˆ›å»ºçš„Agent",
                    tags: "æµ‹è¯•,ç®¡ç†ç•Œé¢",
                    manager: "æµ‹è¯•ç®¡ç†å‘˜",
                    enabled: true
                };
                const response = await fetch('/api/agents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });
                const data = await response.json();
                logResult('agent-results', 'CREATE Agent', response.status, data);
            } catch (error) {
                logResult('agent-results', 'CREATE Agent', 0, null, error.message);
            }
        }

        // æ˜¾ç¤º/éšè—åˆ‡æ¢æµ‹è¯•
        async function testToggleHide() {
            try {
                const response = await fetch(`/api/agents/${getAgentId()}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ enabled: false })
                });
                const data = await response.json();
                logResult('toggle-results', 'HIDE Agent', response.status, data);
            } catch (error) {
                logResult('toggle-results', 'HIDE Agent', 0, null, error.message);
            }
        }

        async function testToggleShow() {
            try {
                const response = await fetch(`/api/agents/${getAgentId()}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ enabled: true })
                });
                const data = await response.json();
                logResult('toggle-results', 'SHOW Agent', response.status, data);
            } catch (error) {
                logResult('toggle-results', 'SHOW Agent', 0, null, error.message);
            }
        }

        // åé¦ˆæŒ‰é’®æµ‹è¯•
        async function testGetButtons() {
            try {
                const response = await fetch('/api/feedback-buttons');
                const data = await response.json();
                logResult('button-results', 'GET Buttons', response.status, data);
            } catch (error) {
                logResult('button-results', 'GET Buttons', 0, null, error.message);
            }
        }

        async function testCreateButton() {
            try {
                const testData = {
                    title: "æµ‹è¯•æŒ‰é’® " + new Date().getTime(),
                    description: "æµ‹è¯•åˆ›å»ºçš„åé¦ˆæŒ‰é’®",
                    url: "https://example.com/test",
                    icon: "test",
                    color: "#ff6b6b",
                    order: 99,
                    enabled: true
                };
                const response = await fetch('/api/feedback-buttons', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });
                const data = await response.json();
                if (data.button && data.button.id) {
                    testButtonId = data.button.id;
                }
                logResult('button-results', 'CREATE Button', response.status, data);
            } catch (error) {
                logResult('button-results', 'CREATE Button', 0, null, error.message);
            }
        }

        async function testUpdateButton() {
            if (!testButtonId) {
                alert('è¯·å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•æŒ‰é’®');
                return;
            }
            
            try {
                const testData = {
                    title: "æ›´æ–°çš„æµ‹è¯•æŒ‰é’® " + new Date().getTime(),
                    description: "è¿™æ˜¯æ›´æ–°åçš„æŒ‰é’®",
                    enabled: false
                };
                const response = await fetch(`/api/feedback-buttons/${testButtonId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(testData)
                });
                const data = await response.json();
                logResult('button-results', 'UPDATE Button', response.status, data);
            } catch (error) {
                logResult('button-results', 'UPDATE Button', 0, null, error.message);
            }
        }

        async function testDeleteButton() {
            if (!testButtonId) {
                alert('è¯·å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•æŒ‰é’®');
                return;
            }
            
            try {
                const response = await fetch(`/api/feedback-buttons/${testButtonId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await response.json();
                logResult('button-results', 'DELETE Button', response.status, data);
                testButtonId = null; // æ¸…é™¤ID
            } catch (error) {
                logResult('button-results', 'DELETE Button', 0, null, error.message);
            }
        }

        // æ•°æ®è·å–æµ‹è¯•
        async function testGetAgents() {
            try {
                const response = await fetch('/api/admin/agents');
                const data = await response.json();
                logResult('data-results', 'GET All Agents', response.status, data);
            } catch (error) {
                logResult('data-results', 'GET All Agents', 0, null, error.message);
            }
        }

        async function testGetApplications() {
            try {
                const response = await fetch('/api/applications');
                const data = await response.json();
                logResult('data-results', 'GET Applications', response.status, data);
            } catch (error) {
                logResult('data-results', 'GET Applications', 0, null, error.message);
            }
        }

        async function testGetFeedback() {
            try {
                const response = await fetch('/api/feedback');
                const data = await response.json();
                logResult('data-results', 'GET Feedback', response.status, data);
            } catch (error) {
                logResult('data-results', 'GET Feedback', 0, null, error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•åŸºç¡€åŠŸèƒ½
        window.onload = function() {
            setTimeout(() => {
                testAgentGet();
                testGetButtons();
            }, 1000);
        }
    </script>
</body>
</html>