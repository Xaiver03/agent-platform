const { PrismaClient } = require('@prisma/client')

const prisma = new PrismaClient()

// å®šä¹‰ä¼˜åŒ–åçš„æ ‡ç­¾ä½“ç³»
const TAG_MAPPING = {
  // AIåŠ©æ‰‹ç±» -> ç»Ÿä¸€ä¸º"AIåŠ©æ‰‹"
  'AIåŠ©æ‰‹': 'AIåŠ©æ‰‹',
  'AIæ™ºèƒ½ä½“': 'AIåŠ©æ‰‹', 
  'æ™ºèƒ½ä½“': 'AIåŠ©æ‰‹',
  'é€šç”¨': 'AIåŠ©æ‰‹',
  
  // ç¼–ç¨‹å¼€å‘ç±» -> ç»Ÿä¸€ä¸º"ç¼–ç¨‹å¼€å‘"
  'ç¼–ç¨‹': 'ç¼–ç¨‹å¼€å‘',
  'AIç¼–ç¨‹': 'ç¼–ç¨‹å¼€å‘',
  'ä»£ç ç¼–è¾‘': 'ç¼–ç¨‹å¼€å‘',
  'ä»£ç è¡¥å…¨': 'ç¼–ç¨‹å¼€å‘',
  'è°ƒè¯•': 'ç¼–ç¨‹å¼€å‘',
  'IDE': 'ç¼–ç¨‹å¼€å‘',
  'å¼€å‘å·¥å…·': 'ç¼–ç¨‹å¼€å‘',
  'å‘½ä»¤è¡Œå·¥å…·': 'ç¼–ç¨‹å¼€å‘',
  'Agentç¼–æ’': 'ç¼–ç¨‹å¼€å‘',
  
  // å†…å®¹åˆ›ä½œç±» -> ç»Ÿä¸€ä¸º"å†…å®¹åˆ›ä½œ"
  'å†™ä½œ': 'å†…å®¹åˆ›ä½œ',
  'è®¾è®¡': 'å†…å®¹åˆ›ä½œ',
  'å›¾åƒç”Ÿæˆ': 'å†…å®¹åˆ›ä½œ',
  'è‰ºæœ¯': 'å†…å®¹åˆ›ä½œ',
  
  // ä¿¡æ¯æœç´¢ç±» -> ç»Ÿä¸€ä¸º"ä¿¡æ¯æœç´¢"
  'æœç´¢': 'ä¿¡æ¯æœç´¢',
  'å®æ—¶æœç´¢': 'ä¿¡æ¯æœç´¢',
  'ç ”ç©¶': 'ä¿¡æ¯æœç´¢',
  'ä¿¡æ¯è·å–': 'ä¿¡æ¯æœç´¢',
  'é—®ç­”': 'ä¿¡æ¯æœç´¢',
  
  // æ•ˆç‡å·¥å…·ç±» -> ç»Ÿä¸€ä¸º"æ•ˆç‡å·¥å…·"
  'è‡ªåŠ¨åŒ–': 'æ•ˆç‡å·¥å…·',
  'ä»»åŠ¡æ‰§è¡Œ': 'æ•ˆç‡å·¥å…·',
  'çŸ¥è¯†ç®¡ç†': 'æ•ˆç‡å·¥å…·',
  'ç¬”è®°': 'æ•ˆç‡å·¥å…·',
  
  // æŠ€æœ¯å¹³å°ç±» -> ç»Ÿä¸€ä¸º"æŠ€æœ¯å¹³å°"
  'APIç½‘å…³': 'æŠ€æœ¯å¹³å°',
  'å¤šæ¨¡å‹': 'æŠ€æœ¯å¹³å°',
  'æˆæœ¬ä¼˜åŒ–': 'æŠ€æœ¯å¹³å°',
  'å¼€æº': 'æŠ€æœ¯å¹³å°',
  
  // å¤šæ¨¡æ€ä¿æŒç‹¬ç«‹
  'å¤šæ¨¡æ€': 'å¤šæ¨¡æ€',
  
  // å…¬å¸æ ‡ç­¾ä¿æŒç‹¬ç«‹ï¼ˆä½†ç®€åŒ–ï¼‰
  'Google': 'Google',
  'xAI': 'xAI'
}

// ä¼˜åŒ–åçš„æ ‡ç­¾ä½“ç³»ï¼ˆ6ä¸ªæ ¸å¿ƒåˆ†ç±»ï¼‰
const OPTIMIZED_TAGS = [
  'AIåŠ©æ‰‹',      // é€šç”¨AIåŠ©æ‰‹å’Œæ™ºèƒ½ä½“
  'ç¼–ç¨‹å¼€å‘',    // æ‰€æœ‰ç¼–ç¨‹ç›¸å…³å·¥å…·
  'å†…å®¹åˆ›ä½œ',    // å†™ä½œã€è®¾è®¡ã€å›¾åƒç”Ÿæˆ
  'ä¿¡æ¯æœç´¢',    // æœç´¢ã€ç ”ç©¶ã€é—®ç­”
  'æ•ˆç‡å·¥å…·',    // è‡ªåŠ¨åŒ–ã€ç®¡ç†ç±»å·¥å…·
  'æŠ€æœ¯å¹³å°'     // APIã€å¼€æºã€æŠ€æœ¯æœåŠ¡
]

// ç‰¹æ®Šæ ‡ç­¾ï¼ˆå¤šæ¨¡æ€ã€å…¬å¸æ ‡ç­¾ï¼‰å¯ä»¥ä½œä¸ºé™„åŠ æ ‡ç­¾
const SPECIAL_TAGS = ['å¤šæ¨¡æ€', 'Google', 'xAI']

// äº§å“æ ‡ç­¾æ˜ å°„è¡¨
const PRODUCT_TAG_MAPPING = {
  'Claude Code': ['ç¼–ç¨‹å¼€å‘', 'AIåŠ©æ‰‹'],
  'ChatGPT Plus': ['AIåŠ©æ‰‹', 'å†…å®¹åˆ›ä½œ'],
  'Midjourney': ['å†…å®¹åˆ›ä½œ', 'å¤šæ¨¡æ€'],
  'Cursor IDE': ['ç¼–ç¨‹å¼€å‘', 'AIåŠ©æ‰‹'],
  'Perplexity AI': ['ä¿¡æ¯æœç´¢', 'AIåŠ©æ‰‹'],
  'Notion AI': ['æ•ˆç‡å·¥å…·', 'å†…å®¹åˆ›ä½œ'],
  'Manus AI': ['AIåŠ©æ‰‹', 'æ•ˆç‡å·¥å…·', 'å¤šæ¨¡æ€'],
  'Gemini CLI': ['ç¼–ç¨‹å¼€å‘', 'Google'],
  'OpenRouter': ['æŠ€æœ¯å¹³å°', 'ç¼–ç¨‹å¼€å‘'],
  'Grok AI': ['AIåŠ©æ‰‹', 'ä¿¡æ¯æœç´¢', 'xAI'],
  'Windsurf': ['ç¼–ç¨‹å¼€å‘', 'AIåŠ©æ‰‹']
}

async function optimizeTags() {
  try {
    console.log('ğŸ”„ å¼€å§‹ä¼˜åŒ–æ ‡ç­¾ä½“ç³»...')
    
    // è·å–æ‰€æœ‰äº§å“
    const agents = await prisma.agent.findMany()
    
    console.log('\nğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”:')
    console.log('================')
    
    for (const agent of agents) {
      const oldTags = agent.tags.split(',').map(t => t.trim())
      const newTags = PRODUCT_TAG_MAPPING[agent.name] || ['AIåŠ©æ‰‹'] // é»˜è®¤æ ‡ç­¾
      
      console.log(`${agent.name}:`)
      console.log(`  ä¼˜åŒ–å‰: ${oldTags.join(', ')}`)
      console.log(`  ä¼˜åŒ–å: ${newTags.join(', ')}`)
      
      // æ›´æ–°æ•°æ®åº“
      await prisma.agent.update({
        where: { id: agent.id },
        data: { tags: newTags.join(', ') }
      })
    }
    
    console.log('\nâœ… æ ‡ç­¾ä¼˜åŒ–å®Œæˆ!')
    
    // æ˜¾ç¤ºä¼˜åŒ–åçš„æ ‡ç­¾ç»Ÿè®¡
    console.log('\nğŸ“ˆ ä¼˜åŒ–åçš„æ ‡ç­¾ä½“ç³»:')
    console.log('==================')
    
    const tagCount = {}
    const updatedAgents = await prisma.agent.findMany({ select: { tags: true } })
    
    updatedAgents.forEach(agent => {
      const tags = agent.tags.split(',').map(t => t.trim())
      tags.forEach(tag => {
        tagCount[tag] = (tagCount[tag] || 0) + 1
      })
    })
    
    Object.entries(tagCount)
      .sort((a, b) => b[1] - a[1])
      .forEach(([tag, count]) => {
        console.log(`  ${tag}: ${count} ä¸ªäº§å“`)
      })
    
    console.log(`\nğŸ“‰ æ ‡ç­¾æ•°é‡: ${Object.keys(tagCount).length} ä¸ª (åŸæ¥ 33 ä¸ª)`)
    console.log('ğŸ’¡ å‡å°‘äº†', 33 - Object.keys(tagCount).length, 'ä¸ªé‡å¤æ ‡ç­¾')
    
  } catch (error) {
    console.error('âŒ ä¼˜åŒ–æ ‡ç­¾æ—¶å‡ºé”™:', error)
  } finally {
    await prisma.$disconnect()
  }
}

optimizeTags()